Users and Authentication API
============================

## Before you begin

Every operation needs to be authenticated with a JWT (JSON Web Token) generated single-time.

The token can be passed within `Authorization: Bearer token-here` header of each request.

Tokens are generated by the `login` endpoint for a given pair of username and password. Username and password is defined by a `kind: BackupUser` in Kubernetes, see [Kubernetes examples](../../examples)

## [User creation and authentication guide - step by step](./guide.md)

## POST `/api/stable/auth/login`

**Example:**

```bash
curl -s -X POST -d '{"username":"admin","password":"admin"}' -H 'Content-Type: application/json' 'http://localhost:8080/api/stable/auth/login'
```

**Example response (200):**

```json
{
    "data": {
        "expire": "2032-02-25T00:32:56+01:00",
        "msg": "Use this sessionId to revoke this token anytime",
        "sessionId": "2d0aa5db61c02ea9a9d7fe6d768021aca98fff1fe75fe214a65ccd6926bb8b77",
        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE5NjEyNzgzNzYsImxvZ2luIjoiYWRtaW4iLCJvcmlnX2lhdCI6MTY0NTkxODM3Nn0.my0WXXMxKCetkomtzRDNIKLWUm4cJ2gxyUCkuAHT6M4"
    },
    "status": true
}
```

The `.data.token` from response is a session secret key, use it to authenticate next API requests using `Authorization: Bearer token-here` header.

### Feature: Generating a JWT token with limited permissions

User can create a restricted session with `/api/stable/auth/login` endpoint, by using extra parameter `operationsScope`.

`operationsScope` extra parameter is a working like an allowlist/whitelist - optional, when specified, then User permissions
are restricted to roles specified there. 

_Notice: Roles specified in `operationsScope` cannot be higher than specified in User's profile or in collection ACL._

**Example:**

```bash
curl -s -X POST -d '{"username":"some-user","password":"test", "operationsScope": {"elements": [{"type": "collection", "name": "iwa-ait", "roles": ["collectionManager"]}]}}' -H 'Content-Type: application/json' 'http://localhost:8080/api/stable/auth/login'
```

_Notice `"operationsScope": {"elements": [{"type": "collection", "name": "iwa-ait", "roles": ["collectionManager"]}]}` in the request body._

### Feature: Access Tokens

Second way to restrict user session is by creating **Access Keys** that are separate passwords associated with same User account, but with additional restrictions.

**Example configuration:**

```yaml
---
apiVersion: backups.riotkit.org/v1alpha1
kind: BackupUser
metadata:
    name: some-user
spec:
    # (...)
    passwordFromRef:
        name: backup-repository-passwords
        entry: admin
    collectionAccessKeys:
        #
        # login: some-user$uploader
        # password: test
        #
        - name: uploader
          collections: ["iwa-ait"]
          roles: ["backupUploader"]
          passwordFromRef:
              name: backup-repository-passwords
              entry: admin_access_key_1
    # (...)
```

_Notice: Roles specified in `collectionAccessKeys` cannot be higher than specified in User's profile or in collection ACL._

**Example JSON payload:**

```json
{"username":"some-user$uploader","password":"test"}
```

When using login endpoint you need to specify **Access Key** name after `$` in username field, and use password specified for that Access Key - it's not a regular password associated with the account.

**Example:**

```bash
curl -s -X POST -d '{"username":"some-user$uploader","password":"test", "operationsScope": {"elements": []}}' -H 'Content-Type: application/json' 'http://localhost:8080/api/stable/auth/login'
```

## GET `/api/stable/auth/user/some-user`

Displays information about user **of given username**.

**Example:**

```bash
curl -s -X GET -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE5NjEyNjMzOTUsImxvZ2luIjoiYWRtaW4iLCJvcmlnX2lhdCI6MTY0NTkwMzM5NX0.kV0baqRJ5DI-0ZSmES2zQTlIlNsd9RZz9DZvQYD7jDc' \
     -H 'Content-Type: application/json' \
     'http://localhost:8080/api/stable/auth/user/some-user'
```

**Example response (200):**

```json
{
    "data": {
        "email": "user@riseup.net",
        "permissions": [
            "collectionManager"
        ]
    },
    "status": true
}
```

**Other responses:**
- [403](../common-responses.md)
- [404](../common-responses.md)


## GET `/api/stable/auth/whoami`

Displays information about current session ad current user.

**Example:**

```bash
curl -s -X GET -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE5NjEyNjMzOTUsImxvZ2luIjoiYWRtaW4iLCJvcmlnX2lhdCI6MTY0NTkwMzM5NX0.kV0baqRJ5DI-0ZSmES2zQTlIlNsd9RZz9DZvQYD7jDc' \
     -H 'Content-Type: application/json' \
     'http://localhost:8080/api/stable/auth/whoami'
```

**Example response (200):**

```json
{
    "data": {
        "email": "riotkit@riseup.net",
        "grantedAccess": {
            "CreatedAt": "2022-02-26T20:23:15.272127+01:00",
            "UpdatedAt": "2022-02-26T20:23:15.272127+01:00",
            "DeletedAt": null,
            "id": "4e1a57bebab9a87faa413934015d9e2ae83cff39cce3b55b02a55e68392964b3",
            "expiresAt": "2032-02-24T20:23:15.271405+01:00",
            "deactivated": false,
            "description": "Login",
            "requesterIP": "::1",
            "user": "admin"
        },
        "permissions": [
            "collectionManager",
            "usersManager",
            "systemAdmin"
        ],
        "sessionId": "4e1a57bebab9a87faa413934015d9e2ae83cff39cce3b55b02a55e68392964b3"
    },
    "status": true
}
```

**Other responses:**
- [403](../common-responses.md)

## GET `/api/stable/auth/logout`

Allows log out own session, or session of other user (if user has access rights to do it).

**Required roles:**
- `systemAdmin` (if wanting to log out other user's session)

**Optional query string parameters:**
- sessionId

**Example:**

```bash
curl -s -X DELETE -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE5NjEyNjMzOTUsImxvZ2luIjoiYWRtaW4iLCJvcmlnX2lhdCI6MTY0NTkwMzM5NX0.kV0baqRJ5DI-0ZSmES2zQTlIlNsd9RZz9DZvQYD7jDc' \
     -H 'Content-Type: application/json' \
     'http://localhost:8080/api/stable/auth/logout'
```

**Example response:**

```json
{
    "data": {
        "message": "JWT was revoked",
        "sessionId": "4e1a57bebab9a87faa413934015d9e2ae83cff39cce3b55b02a55e68392964b3"
    },
    "status": true
}
```

**Other responses:**
- [403](../common-responses.md)
- [404](../common-responses.md)
- [500](../common-responses.md)


## GET `/api/stable/auth/token`

Lists all granted JWTs to given account.

**Required roles:**
- `systemAdmin` (if wanting to act as other user)

**Optional query string parameters:**
- userName

**Example:**

```bash
curl -s -X GET -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE5NjEyNzkxNDcsImxvZ2luIjoiYWRtaW4iLCJvcmlnX2lhdCI6MTY0NTkxOTE0N30.f8ANZup-rifDwTVUNsm9dEFerOjLh2Wsqz8IBw0j3zk' \ 
     -H 'Content-Type: application/json' \
     'http://localhost:8080/api/stable/auth/token'
```

**Example response (200):**

```json
{
    "data": {
        "grantedAccesses": [
            {
                "CreatedAt": "2022-02-27T00:45:47.256269+01:00",
                "UpdatedAt": "2022-02-27T00:45:47.256269+01:00",
                "DeletedAt": null,
                "id": "8c313de003f20bd34f78c6fd26c3f5943e6339b744e111569d9ed1d121796839",
                "expiresAt": "2032-02-25T00:45:47.255996+01:00",
                "deactivated": false,
                "description": "Login",
                "requesterIP": "1.2.3.4",
                "user": "admin"
            }
        ]
    },
    "status": true
}
```
